#!/usr/bin/env bash

# Î¤Î¿ Ï€Î±ÏÏŒÎ½ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ Ï„Î± Ï€ÏÏ‰Ï„Î¿Î³ÎµÎ½Î® Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï€Î¿Ï… Ï€Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Î±Ï€ÏŒ
# Ï„Î¿ database server Ï„Î¿Ï… ÎŸÎ Î£ÎŸÎ¥. Î¤Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î­ÏÏ‡Î¿Î½Ï„Î±Î¹ Î¼Îµ Î¼Î¿ÏÏ†Î® Ï€Î¿Ï… Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹
# Î¬Î¼ÎµÏƒÎ± ÎºÎ±Ï„Î¬Î»Î»Î·Î»Î· Î³Î¹Î± data processing, ÎºÎ±Î¸ÏŽÏ‚ ÎµÎ¼Ï€ÎµÏÎ¹Î­Ï‡Î¿Ï…Î½ ÎµÏ€Î¹ÎºÎµÏ†Î±Î»Î¯Î´Î±,
# ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ»Ï€. Î•Î¾Î¬Î»Î»Î¿Ï…, Ï‰Ï‚ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î®Ï‚ ÏƒÏ„Î·Î»ÏŽÎ½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Ï„Î¿ pipe.
#
# Î¤Î¿ Ï€Î±ÏÏŒÎ½ Ï€ÏÏŒÎ³ÏÎ±Î¼Î¼Î± Î±Ï€Î±Î»ÎµÎ¯Ï†ÎµÎ¹ Ï„Î·Î½ ÎµÏ€Î¹ÎºÎµÏ†Î±Î»Î¯Î´Î± (Î´ÏÎ¿ Ï€ÏÏŽÏ„ÎµÏ‚ Î³ÏÎ±Î¼Î¼Î­Ï‚) ÎºÎ±Î¹ Ï„Î±
# ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î´ÏÎ¿ Î³ÏÎ±Î¼Î¼Î­Ï‚), ÎµÎ½ÏŽ Î¼ÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ Ï„Î¿Î½ Î´Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÏ„Î® ÏƒÏ„Î·Î»ÏŽÎ½
# ÏƒÎµ tab, ÎµÎ½ÏŽ Ï€Î±ÏÎ¬Î»Î»Î·Î»Î± Î±Ï†Î±Î¹ÏÎµÎ¯ Ï„Î± ÎºÎµÎ½Î¬ Î±Ï€ÏŒ Ï„Î·Î½ Î±ÏÏ‡Î® ÎºÎ±Î¹ Ï„Î¿ Ï„Î­Î»Î¿Ï‚ ÎºÎ¬Î¸Îµ ÏƒÏ„Î®Î»Î·Ï‚.

progname="$(basename $0)"

usage() {
	echo "usage: ${progname} [ -c columns ] [ files... ]" >&2
	exit 1
}

errs=
cols=
date=

while getopts ":c:d:" opt
do
	case "${opt}" in
	c)
		cols="${OPTARG}"
		;;
	d)
		date="${OPTARG},${date}"
		;;
	\:)
		echo "${progname}: -${OPTARG}: missing argument" >&2
		errs=1
		;;
	\?)
		echo "${progname}: -${OPTARG}: invalid option" >&2
		errs=1
		;;
	esac
done

[ -n "${errs}" ] && usage

shift $(expr ${OPTIND} - 1)

sed '1,2d
s; *| *;	;g
s;^ *;;
s; *$;;' "$@" | awk -v cols="${cols}" -v date="${date}" 'BEGIN {
	FS = "\t"
	OFS = "\t"
	nd = split(date, dt, ",")
}

NF != cols {
	next
}

{
	for (i = 1; i < nd; i++)
	$(dt[i]) = dmy2ymd($(dt[i]))

	print
}

function dmy2ymd(dmy,			a, n, y, m, d) {
	n = split(dmy, a, "[^0-9]")

	if (n != 3)
	return ""

	# ÎšÎ¬Ï€Î¿Î¹ÎµÏ‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯ÎµÏ‚ Î´Î¯Î½Î¿Î½Ï„Î±Î¹ Î®Î´Î· ÏƒÏ„Î· Î¼Î¿ÏÏ†Î® YYYY-MM-DD. Î ÏÏŒÎºÎµÎ¹Ï„Î±Î¹ Î³Î¹Î±
        # Î¼Î¯Î± Î±ÎºÏŒÎ¼Î· Ï„ÏƒÎ±Ï€Î±Ï„ÏƒÎ¿Ï…Î»Î¹Î¬ Ï„Î·Ï‚ Neuropublic Ï€Î¿Ï… Î¼Î±Ï‚ Ï€Î±ÏÎ­Ï‡ÎµÎ¹ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î±.
	# Î‘Ï€Î¿Ï†Î±Î¹Î½ÏŒÎ¼Î±ÏƒÏ„Îµ ÎµÎ»Î­Î³Ï‡Î¿Î½Ï„Î±Ï‚ Ï„Î¿ Ï€ÏÏŽÏ„Î¿ ÏƒÏ…ÏƒÏ„Î±Ï„Î¹ÎºÏŒ Ï„Î·Ï‚ Î´Î¿Î¸ÎµÎ¯ÏƒÎ·Ï‚ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚.

	if (a[1] > 31) {
		y = a[1]
		m = a[2]
		d = a[3]
	}
	else {
		y = a[3]
		m = a[2]
		d = a[1]
	}

	return sprintf("%04d-%02d-%02d", y, m, d)
}'
