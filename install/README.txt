================================================================================
Επικοινωνία Honeywell WIN-PAK SE 4.6 με Ubuntu16.04
================================================================================

Το σύστημα ελέγχου πρόσβασης και ωραρίου που έχει προμηθευτεί ο ΔΘ, ήδη από την
κατασκευή του Νέου Δημαρχιακού Μεγάρου (ΝΔΜ), είναι ηλεκτρονικό και αποτελείται
από καρταναγνώστες οι οποίοι επικοινωνούν με κεντρικούς controllers οι οποίοι
με τη σειρά τους επικοινωνούν δικτυακά με server Windows 10 στον οποίο υπάρχει
εγκατεστημένη η εφαρμογή WIN-PAK SE 4.6 της εταιρείας Honeywell. Η συγκεκριμένη
εφαρμογή ενημερώνει SQLserver database και κρατά πλήθος στοιχείων που αφορούν
ό,τι έχει να κάνει με τις κάρτες και τους ακρατναγνώστες, εντός ή εκτός ΝΔΜ.

Πράγματι, εκτός από το ΝΔΜ, υπάρχουν σήμερα (Μάιος 2019) καρταναγνώστες στο
Κέντρο Ιστορίας (KIS) και στο κτίριο της Κεντρικής Δημοτικής Βιβλιοθήκης (ΚΔΒ),
ενώ προβλέπεται στο προσεχές μέλλον να εγκατασταθούν καρταναγνώστες και σε άλλα
κτίρια του ΔΘ τα οποία στεγάζουν πολυπληθείς Υπηρεσίες του ΔΘ, όπως Βιώσιμη,
Βαφοπούλειο, Πολεοδομία, Αρχιτεκτονικό, Πρόνοια, ΣΜΑ κλπ.

Η εφαρμογή προσφέρει πολλές δυνατότητες συλλογής και επεξεργασίας στοιχείων,
ωστόσο η πλέον χρήσιμη δυνατότητα είναι η πρόσβαση στην database μέσω SQL μέσω
του client sqlcmd, ο οποίος παρέχεται δωρεάν από την εταιρεία Microsoft.
Κάνοντας χρήση της δυνατότητας υποβολής SQL ερωτημάτων στην database 'WIN-PAK'
μπορούμε να στήσουμε ξεχωριστό Linux application server με MySQL/MariaDB, στον
οποίο εγκαθιστούμε ειδικά προγράμματα εφαρμογών μέσω των οποίων ενημερώνουμε
δική μας database και παρέχουμε δικά μας προγράμματα εφαρμογών με τα οποία
μπορούμε να παράξουμε χρήσιμα reports που αφορούν στο σύστημα ελέγχου πρόσβασης
και ωραρίου.
  
Προκειμένου να επικοινωνήσουμε από Ubuntu16.04 με την database 'WIN-PAK PRO',
θα πρέπει να γίνουν οι εξής ενέργειες:

********************************************************************************
Από την πλευρά του WIN-PAK server (Windows 10)
********************************************************************************

Τρέχουμε τον SQL Server 2014 Configuration Manager και κάνουμε κλικ στην
επιλογή "SQL Server Network Configuration". Από εκεί επιλέγουμε την επιλογή
"Protocols for SQLEXPRESS" και στη συνέχεια κάνουμε δεξί κλικ στην επιλογή
"TCP/IP" και ελέγχουμε το συγκεκριμένο πρωτόκολλο να είναι enabled. Κατόπιν
επιλέγουμε την επιλογή "Properties" από το menu, επιλέγουμε το "IP Adresses"
και ελέγχουμε το "TCP Dynamic Ports" στην ενότητα "IPAll". Αυτό το port μπορεί
να είναι π.χ. "48485", οπότε το ίδιο port θα πρέπει να χρησιμοποιήσουμε στον
client.

********************************************************************************
Από την πλευρά του client (Linux)
********************************************************************************

--------------------------------------------------------------------------------
Δημιουργία SQL login στο WIN-PAK
--------------------------------------------------------------------------------

Συνδεόμαστε ως 'admin' στον server που φιλοξενεί το WIN-PAK με το remina ή άλλο
remote desktop πρόγραμμα. Εκεί τρέχουμε το Microsoft SQL Server Management
Studio ως system administrator με το login name 'sa'.

Στα αριστερά μας πρέπει να υπάρχει παράθυρο με τίτλο 'Object Explorer'. Αν δεν
υπάρχει αυτό το παράθυρο, το ανοίγουμε είτε πατώντας το πλήκτρο F8, είτε μέσω
της διαδρομής 'View->Object Explorer'. Αφού ανοίξει το παράθυρο του 'Object
Explorer', ακολουθούμε τη διαδρομή:

SRV-ACCESS\SQLEXPRESS (SQl Server 12.0.4100 - sa)
	Sequrity
		Logins

και κάνουμε δεξί κλίκ στο 'Logins' όπου επιλέγουμε 'New Login…' από το menu.
Στη φόρμα 'Login - New' που θα εμφανιστεί δίνουμε login name 'kartel' ή άλλο
όνομα που επιθυμούμε. Επιλέγουμε SQL Server authentication και αποεπιλέγουμε
τις επιλογές που αφορούν στο password και άλλες επιλογές που ίσως εμφανίζονται
τσεκαρισμένες, και συμπληρώνουμε τα πεδία 'Password' και 'Confirm password'.

Στο πεδίο Default database δίνουμε την επιλογή 'WIN-PAK PRO' και στο πεδίο
'Default language' αφήνουμε την επιλογή <default> ή επιλέγουμε 'English' και
κάνουμε κλικ στο πλήκτρο 'OK' εισάγοντας τον χρήστη στο σύστημα.

................................................................................
Server Roles
................................................................................

Κατόπιν κάνουμε δεξί κλικ στον νεοδημιουργηθέντα χρήστη και επιλέγουμε
'Properties' από το menu. Από εκεί επιλέγουμε 'Server Roles' όπου τσεκάρουμε
μόνο την επιλογή 'public'.

................................................................................
User mapping
................................................................................
Από την επιλογή 'User Mapping' τσεκάρουμε μόνο την database 'WIN-PAK PRO'.

................................................................................
Securables
................................................................................
Στην επιλογή 'Securables' ελέγχουμε να υπάρχει ο 'SRV-ACCESS\SQLEXPRESS' server
στο παράθυρο με τίτλο 'Securables:'

................................................................................
Permissions for SRV-ACCESS\SQLEXPRESS:
................................................................................
Στα explicit permissions πρέπει να είναι τσεκαρισμένο μόνο το 'Connect SQL' στη
στήλη 'Grant', ενώ στα effective permissions πρέπει να υπάρχουν μόνο οι
επιλογές 'CONNECT SQL' και 'VIEW ANY DATABASE'

................................................................................
Status
................................................................................

Ελέγχουμε να είναι τσεκαρισμένα τα radio buttons 'Grant' και 'Enabled'.

Στο σημείο αυτό έχουμε τελειώσει με τη δημιουργία SQL login στο WIN-PAK.

--------------------------------------------------------------------------------
Δημιουργία SQL user στο WIN-PAK
--------------------------------------------------------------------------------

Συνδεόμαστε ως 'admin' στον server που φιλοξενεί το WIN-PAK με το remina ή άλλο
remote desktop πρόγραμμα . Εκεί τρέχουμε το Microsoft SQL Server Management Studio
ως system administrator με το login name 'sa'.

Στα αριστερά μας πρέπει να υπάρχει παράθυρο με τίτλο 'Object Explorer'. Αν δεν
υπάρχει αυτό το παράθυρο, το ανοίγουμε είτε πατώντας το πλήκτρο F8, είτε μέσω της
διαδρομής 'View->Object Explorer'. Αφού ανοίξει το παράθυρο του 'Object Explorer',
ακολουθούμε τη διαδρομή:

SRV-ACCESS\SQLEXPRESS (SQl Server 12.0.4100 - sa)
	Databases
		WIN-PAK PRO
			Security

Αν δεν έχει προστεθεί αυτόματα χρήστης με το ίδιο όνομα που δώσαμε πριν, τότε
κάνουμε δεξί κλικ στην επιλογή 'Users' και επιλέγουμε 'New User…' από το menu,
αλλιώς κάνουμε δεξί κλικ στον user και επιλέγουμε 'Properties' από το menu.

................................................................................
General
................................................................................

Στη φόρμα 'Database User - New' επιλέγουμε user type 'SQL user with login'.
Συμπληρώνουμε το 'User name' και το 'Login name' και στο 'Default schema'
δίνουμε 'dbo'.

................................................................................
Owned Schemas
................................................................................

Ελέγχουμε αν όλες οι επιλογές είναι αποεπιλεγμένες.

................................................................................
Membership
................................................................................

Και εδώ ελέγχουμε αν όλες οι επιλογές είναι αποεπιλεγμένες.

................................................................................
Securables
................................................................................

Κάνουμε κλικ στο 'Search' και προσπαθούμε να εντοπίσουμε specific objects με
object type 'Tables' και ονόματα 'Cards', 'History' και 'HWIndepententDevices'

................................................................................
Permissions for WIN-PAK PRO:
................................................................................

Στα explicit permissions πρέπει να είναι τσεκαρισμένο μόνο το 'Grant' στο
permission με 'Grantor' 'dbo' και για τους τρεις πίνακες.

Στο σημείο αυτό έχουμε τελειώσει με τη δημιουργία SQL user στο WIN-PAK και
είμαστε έτοιμοι να συνδεθούμε από τον client στον WIN-PAK server με τον sqlcmd.
Δοκιμάζουμε την εντολή:

sqlcmd -S 'wp-server\SQLEXPRESS,48485' -U user_name -P user_password

και εφόσον συνδεθήκαμε επιτυχώς δίνουμε το query:

SELECT TOP 10 [CardNumber]
FROM [Card]
ORDER BY [CardNumber]
GO

Θα πρέπει να πάρουμε τους αριθμούς των δέκα τελευταίων καρτών που έχουν εισαχθεί
στο WIN-PAK.

================================================================================
Εγκατάσταση εφαρμογής 'kartel' στον application server
================================================================================

Η διαδικασία εγκατάστασης έχει ως εξής:

********************************************************************************
sqlcmd installation (AP server / WP client)
********************************************************************************

Εγκαθιστώ το "sqlcmd" στον Ubuntu application server ο οποίος εν προκειμένω
θα λειτουργεί ως client εφόσον η database WIN-PAK βρίσκεται στον WP server.

	curl https://packages.microsoft.com/keys/microsoft.asc |\
		sudo apt-key add -
	curl https://packages.microsoft.com/config/ubuntu/16.04/prod.list |\
		sudo tee /etc/apt/sources.list.d/msprod.list
	sudo apt-get update
	sudo apt-get install mssql-tools unixodbc-dev
	sudo apt-get update
	sudo apt-get install mssql-tools

********************************************************************************
WIN-PAK login and SQL user creation (WP server)
********************************************************************************

Δημιουργία login user και SQL user στο WIN-PAK. Το όνομα που θα επιλέξετε
μπορεί να είναι οποιοδήποτε, αλλά για λόγους τάξης είναι καλό να δώσουμε το
όνομα "kartel". Όσον αφορά την default database και το default schema για
τον εν λόγω user, αυτά πρέπει να είναι "WIN-PAK PRO" και "dbo" αντίστοιχα.

Μετά τη δημιουργία του ως άνω user, πρέπει να δώσουμε δικαιώματα SELECT
στους πίνακες "History", "Card" και "HWIndepententDevice"

********************************************************************************
Clone "kartel" repository (AP server)
********************************************************************************

Κάνουμε login με το δικό μας login name στον Ubuntu application server (AP)
και κατόπιν κάνουμε clone το repository "kartel" ως εξής:

	hg clone https://panos1962@bitbucket.org/panos1962/kartel

Αν δεν διαθέτουμε το mercurial (hg) θα πρέπει να το εγκαταστήσουμε.

********************************************************************************
Προετοιμασία "kartel" installation (AP server)
********************************************************************************

Μεταφερόμαστε στο kartel directory που μόλις δημιουργήσαμε και φτιάχνουμε
το αρχείο "local/winpak.cf" ως εξής:

	cp install/winpak.cf local/winpak.cf

Διορθώνουμε αυτό το αρχείο γράφοντας τα σωστά στοιχεία χρησιμοποιώντας τον
editor της αρεσκείας μας:

	vim local/winpak.cf

********************************************************************************
"kartel" installation (AP server)
********************************************************************************

Εγκαθιστούμε το πρόγραμμα στον AP server ως εξής:

	sudo install/install -X -w [ -b ]

Τα default στοιχεία της εγκατάστασης είναι:

	Directory: /var/opt/kartel [ αλλάζει με την option -d ]
	User: kartel [ αλλάζει με την option -u ]
	Group: kartel [ αλλάζει με την option -g ]

	SQL configuration file: local/winpak.cf
		[ τίθεται με την option -w ]
		[ αλλάζει με την option -W ]

	Local database configuration file: local/karteldb.cf
		[ τίθεται με την option -b ]
		[ αλλάζει με την option -B ]
